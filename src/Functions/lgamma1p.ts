import lgamma from "./lgamma";
import log1pmx from "./log1pmx";
import logcf from "./logcf";
import { EULER } from "./Constants";

/**
 * Computes the natural logarithm of the gamma function at (1 + a): ln(Γ(1 + a)),
 * providing improved accuracy for small values of a.
 *
 * This implementation is based on a series expansion and continued fraction
 * approximation for better numerical stability when a is close to zero.
 *
 * The below implementation is a TypeScript adaptation of the lgamma1p function
 * from the R programming language.
 *
 * @param a The input value for which to compute lgamma1p
 * @returns The natural logarithm of the gamma function at (1 + a): ln(Γ(1 + a))
 */
export default function lgamma1p(a: number): number {
  if (Math.abs(a) >= 0.5) {
    return lgamma(a + 1);
  }

  const coeffs: number[] = [
    0.3224670334241132182362075833230126e-0,
    0.6735230105319809513324605383715000e-1,
    0.2058080842778454787900092413529198e-1,
    0.7385551028673985266273097291406834e-2,
    0.2890510330741523285752988298486755e-2,
    0.1192753911703260977113935692828109e-2,
    0.5096695247430424223356548135815582e-3,
    0.2231547584535793797614188036013401e-3,
    0.9945751278180853371459589003190170e-4,
    0.4492623673813314170020750240635786e-4,
    0.2050721277567069155316650397830591e-4,
    0.9439488275268395903987425104415055e-5,
    0.4374866789907487804181793223952411e-5,
    0.2039215753801366236781900709670839e-5,
    0.9551412130407419832857179772951265e-6,
    0.4492469198764566043294290331193655e-6,
    0.2120718480555466586923135901077628e-6,
    0.1004322482396809960872083050053344e-6,
    0.4769810169363980565760193417246730e-7,
    0.2271109460894316491031998116062124e-7,
    0.1083865921489695409107491757968159e-7,
    0.5183475041970046655121248647057669e-8,
    0.2483674543802478317185008663991718e-8,
    0.1192140140586091207442548202774640e-8,
    0.5731367241678862013330194857961011e-9,
    0.2759522885124233145178149692816341e-9,
    0.1330476437424448948149715720858008e-9,
    0.6422964563838100022082448087644648e-10,
    0.3104424774732227276239215783404066e-10,
    0.1502138408075414217093301048780668e-10,
    0.7275974480239079662504549924814047e-11,
    0.3527742476575915083615072228655483e-11,
    0.1711991790559617908601084114443031e-11,
    0.8315385841420284819798357793954418e-12,
    0.4042200525289440065536008957032895e-12,
    0.1966475631096616490411045679010286e-12,
    0.9573630387838555763782200936508615e-13,
    0.4664076026428374224576492565974577e-13,
    0.2273736960065972320633279596737272e-13,
    0.1109139947083452201658320007192334e-13
  ];

  const N: number = coeffs.length;
  const c: number = 0.2273736845824652515226821577978691e-12;
  let lgam: number = c * logcf(-a / 2, N + 2, 1, 1e-14);
  for (let i = N - 1; i >= 0; i--) {
    lgam = coeffs[i] - a * lgam;
  }
  return (a * lgam - EULER) * a - log1pmx(a);
}
