import lgamma from "./lgamma";
import ldexp from "./ldexp";
import lgamma1p from "./lgamma1p";

export default function stirlerr(n: number): number {
  const S0: number = 0.083333333333333333333;
  const S1: number = 0.00277777777777777777778;
  const S2: number = 0.00079365079365079365079365;
  const S3: number = 0.000595238095238095238095238;
  const S4: number = 0.0008417508417508417508417508;
  const S5: number = 0.0019175269175269175269175262;
  const S6: number = 0.0064102564102564102564102561;
  const S7: number = 0.029550653594771241830065352;
  const S8: number = 0.17964437236883057316493850;
  const S9: number = 1.3924322169059011164274315;
  const S10: number = 13.402864044168391994478957;
  const S11: number = 156.84828462600201730636509;
  const S12: number = 2193.1033333333333333333333;
  const S13: number = 36108.771253724989357173269;
  const S14: number = 691472.26885131306710839498;
  const S15: number = 15238221.539407416192283370;
  const S16: number = 382900751.39141414141414141;
  const M_LN_2PI: number = 1.837877066409345483560659472811;
  const M_LN_SQRT_2PI: number = 0.918938533204672741780329736406;

  const sferr_halves: number[] = [
    0.0,
    0.1534264097200273452913848,
    0.0810614667953272582196702,
    0.0548141210519176538961390,
    0.0413406959554092940938221,
    0.03316287351993628748511048,
    0.02767792568499833914878929,
    0.02374616365629749597132920,
    0.02079067210376509311152277,
    0.01848845053267318523077934,
    0.01664469118982119216319487,
    0.01513497322191737887351255,
    0.01387612882307074799874573,
    0.01281046524292022692424986,
    0.01189670994589177009505572,
    0.01110455975820691732662991,
    0.010411265261972096497478567,
    0.009799416126158803298389475,
    0.009255462182712732917728637,
    0.008768700134139385462952823,
    0.008330563433362871256469318,
    0.007934114564314020547248100,
    0.007573675487951840794972024,
    0.007244554301320383179543912,
    0.006942840107209529865664152,
    0.006665247032707682442354394,
    0.006408994188004207068439631,
    0.006171712263039457647532867,
    0.005951370112758847735624416,
    0.005746216513010115682023589,
    0.005554733551962801371038690
  ];

  let nn: number;

  if (n <= 23.5) {
    nn = n + n;
    if (n <= 15 && nn === Math.trunc(nn)) {
      return sferr_halves[nn];
    }
    if (n <= 5.25) {
      if (n >= 1) {
        const l_n: number = Math.log(n);
        return lgamma(n) + n * (1 - l_n) + ldexp(l_n - M_LN_2PI, -1);
      } else {
        return lgamma1p(n) - (n + 0.5) * Math.log(n) + n - M_LN_SQRT_2PI;
      }
    }
    nn = n*n;
    if (n > 12.8) {
      return (S0-(S1-(S2-(S3-(S4-(S5 -S6/nn)/nn)/nn)/nn)/nn)/nn)/n;
    }
    if (n > 12.3) {
      return (S0-(S1-(S2-(S3-(S4-(S5-(S6 -S7/nn)/nn)/nn)/nn)/nn)/nn)/nn)/n;
    }
    if (n >  8.9) {
      return (S0-(S1-(S2-(S3-(S4-(S5-(S6-(S7 -S8/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/n;
    }
    if (n >  7.3) {
      return (S0-(S1-(S2-(S3-(S4-(S5-(S6-(S7-(S8-(S9-S10/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/n;
    }
    if (n >  6.6)  {
      return (S0-(S1-(S2-(S3-(S4-(S5-(S6-(S7-(S8-(S9-(S10-(S11-S12/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/n;
    }
    if (n >  6.1)  {
      return (S0-(S1-(S2-(S3-(S4-(S5-(S6-(S7-(S8-(S9-(S10-(S11-(S12-(S13-S14/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/n;
    }
    return (S0-(S1-(S2-(S3-(S4-(S5-(S6-(S7-(S8-(S9-(S10-(S11-(S12-(S13-(S14-(S15-S16/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/nn)/n;
  } else {
    nn = n * n;
    if (n > 15.7e6) {
      return S0/n;
    }
    if (n > 6180) {
      return (S0 -S1/nn)/n;
    }
    if (n > 205) {
      return (S0-(S1 -S2/nn)/nn)/n;
    }
    if (n > 86) {
      return (S0-(S1-(S2 -S3/nn)/nn)/nn)/n;
    }
    if (n > 27) {
      return (S0-(S1-(S2-(S3 -S4/nn)/nn)/nn)/nn)/n;
    }

    return (S0-(S1-(S2-(S3-(S4 -S5/nn)/nn)/nn)/nn)/nn)/n;
  }
}
